@page "/admin/dashboard"
@rendermode InteractiveServer
@using Oikos.Common.Resources
@using Oikos.Application.Services.Invoice.Models
@using Oikos.Domain.Enums

<div class="pa-4 pa-sm-10">
    <div class="mb-10">
        <MudText Typo="Typo.h4" GutterBottom="true" Style="font-weight: 300; opacity: 0.7;">@_greetingText</MudText>
    </div>

    <div class="d-flex align-end justify-space-between mb-6">
        <div>
            <MudText Typo="Typo.h3" Style="font-family: 'Times New Roman', serif; font-weight: 700; color: #1a1a1a;">@Loc["AdminDashboard_CaseManagementTitle"]</MudText>
            <MudText Typo="Typo.h6" Class="mud-text-secondary" Style="font-weight: 400; font-size: 1.1rem;">@Loc["AdminDashboard_CaseManagementSubtitle"]</MudText>
        </div>
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.People"
                   Href="/admin/clients"
                   Class="rounded-lg px-6 py-2"
                   Style="border-color: #e0e0e0; text-transform: none; font-weight: 500;">
            @Loc["AdminDashboard_MandantenButton"]
        </MudButton>
    </div>

    <!-- Compact stat cards -->
    <MudGrid Spacing="2" Class="mb-4">
        @for (int i = 0; i < _statusSummaries.Count; i++)
        {
            var summary = _statusSummaries[i];
            var tabIdx = i;
            <MudItem xs="6" sm="4" md="2">
                <MudPaper Elevation="0"
                          Class="pa-4 rounded-xl border text-center stat-card"
                          Style="@($"opacity: {(summary.Count == 0 ? "0.55" : "1")};")"
                          @onclick="@(() => SelectTab(tabIdx))">
                    <MudIcon Icon="@summary.Icon" Size="Size.Small" Class="mb-2 mud-text-secondary" />
                    <MudText Typo="Typo.h5" Style="font-weight: 800; color: #2d2d2d;">@summary.Count</MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@summary.Name</MudText>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>

    <!-- Queue tabs -->
    <MudTabs @ref="_tabs"
             ActivePanelIndexChanged="OnTabChangedAsync"
             Rounded="true"
             ApplyEffectsToContainer="true"
             PanelClass="pa-0"
             Class="queue-tabs">
        @foreach (var queue in Queues)
        {
            <MudTabPanel Text="@Loc[queue.LocalizationKey]" />
        }
    </MudTabs>

    <!-- Case table — shared content area below tabs -->
    <MudPaper Elevation="0" Class="rounded-b-xl border" Style="border-color: #e0e0e0; border-top: none; min-height: 180px;">
        @if (_loadingInvoices)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            <div class="pa-8" />
        }
        else if (!_tabInvoices.Any())
        {
            <div class="pa-12 d-flex flex-column align-center justify-center" style="min-height: 180px;">
                <MudIcon Icon="@Icons.Material.Outlined.Inbox" Size="Size.Large" Class="mud-text-secondary mb-3" Style="opacity: 0.35;" />
                <MudText Typo="Typo.body1" Class="mud-text-secondary">Keine Fälle in dieser Warteschlange</MudText>
            </div>
        }
        else
        {
            <MudTable Items="_tabInvoices" Hover="true" Dense="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Fall-ID</MudTh>
                    <MudTh>Mandant</MudTh>
                    <MudTh>Schuldner</MudTh>
                    <MudTh>Betrag</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Eingereicht</MudTh>
                    <MudTh class="text-right">Aktion</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@(string.IsNullOrWhiteSpace(context.TicketNumber) ? $"#{context.Number}" : context.TicketNumber)</MudTd>
                    <MudTd>
                        <MudStack Spacing="0">
                            <MudLink Href="@($"/admin/invoices/{context.Id}")" Underline="Underline.None">
                                <MudText Typo="Typo.subtitle2">@context.UserName</MudText>
                            </MudLink>
                            @if (!string.IsNullOrWhiteSpace(context.UserEmail))
                            {
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.UserEmail</MudText>
                            }
                        </MudStack>
                    </MudTd>
                    <MudTd>@context.Company</MudTd>
                    <MudTd>@FormatAmount(context)</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="@GetPrimaryStatusColor(context.PrimaryStatus)">
                            @Loc[$"InvoicePrimaryStatus_{context.PrimaryStatus}"]
                        </MudChip>
                    </MudTd>
                    <MudTd>@FormatCreatedAt(context)</MudTd>
                    <MudTd Class="text-right">
                        <MudTooltip Text="@Loc["AdminViewDetails"]" Color="Color.Primary">
                            <MudIconButton Icon="@Icons.Material.Outlined.Visibility"
                                           Color="Color.Primary"
                                           OnClick="@(() => _navManager.NavigateTo($"/admin/invoices/{context.Id}"))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
            @if (_tabTotalCount > TabPageSize)
            {
                <div class="pa-3 d-flex justify-end align-center" style="border-top: 1px solid #f0f0f0;">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary mr-3">
                        Zeige @_tabInvoices.Count von @_tabTotalCount
                    </MudText>
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               Href="@Queues[_activeTabIndex].ViewAllUri"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               Size="Size.Small">
                        Alle anzeigen
                    </MudButton>
                </div>
            }
        }
    </MudPaper>
</div>

<style>
    .stat-card {
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: #ffffff;
        border: 1px solid #e0e0e0 !important;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        border-color: #bdbdbd !important;
        background-color: #fafafa !important;
    }
    .stat-card:active {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
</style>
