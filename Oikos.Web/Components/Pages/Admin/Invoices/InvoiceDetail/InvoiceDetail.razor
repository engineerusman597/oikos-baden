@page "/admin/invoices/{InvoiceId:int}"
@using Oikos.Web.Components.Layout.PageLayout
@namespace Oikos.Web.Components.Pages.Admin.Invoices.InvoiceDetail
@using Oikos.Application.Services.Invoice.Models
@using Oikos.Domain.Enums
@using static Microsoft.AspNetCore.Components.Web.RenderMode

@rendermode InteractiveServer
@attribute [StreamRendering]

<PageLayout>
    <HeaderContent>
        <StandardPageHeader Title="@Loc["AdminInvoiceDetailTitle"]">
            <StartContent>
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">
                    @Loc["InvoiceDetailBack"]
                </MudButton>
            </StartContent>
            <ChildContent>
                @if (_invoice is not null)
                {
                    <MudStack Row="true" Spacing="2">
                        @if (_canSendRueckfrage)
                        {
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Warning"
                                       StartIcon="@Icons.Material.Filled.QuestionAnswer"
                                       OnClick="OpenRueckfrageDialogAsync"
                                       Disabled="@_isSaving">
                                @Loc["InvoiceDetail_RueckfrageButton"]
                            </MudButton>
                        }
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.SwapHoriz"
                                   OnClick="OpenStatusDialogAsync"
                                   Disabled="@_isSaving">
                            @Loc["InvoiceDetail_ChangeStatusButton"]
                        </MudButton>
                    </MudStack>
                }
            </ChildContent>
        </StandardPageHeader>
    </HeaderContent>
    <ChildContent>
        @if (_isLoading)
        {
            <MudGrid Spacing="3">
                <MudItem xs="12">
                    <MudSkeleton Variant="Variant.Rectangular" Height="160px" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSkeleton Variant="Variant.Rectangular" Height="140px" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSkeleton Variant="Variant.Rectangular" Height="140px" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSkeleton Variant="Variant.Rectangular" Height="140px" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSkeleton Variant="Variant.Rectangular" Height="140px" />
                </MudItem>
            </MudGrid>
        }
        else if (_invoice is null)
        {
            <MudAlert Severity="Severity.Warning">@Loc["InvoiceDetailNotFound"]</MudAlert>
        }
        else
        {
            <MudPaper Class="invoice-detail-hero pa-4" Elevation="0" Outlined="true">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="invoice-detail-hero-content">
                    <MudAvatar Size="Size.Large" Color="Color.Primary">
                        @(FormatCompany(_invoice).FirstOrDefault())
                    </MudAvatar>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h4" Class="invoice-detail-title">@FormatValue(_invoice.TicketNumber)</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">@FormatCompany(_invoice)</MudText>
                        <MudStack Row="true" Spacing="1" Class="invoice-detail-chips">
                            <MudChip T="string" Color="@ResolveColor(_invoice.StageColor, Color.Info)" Variant="Variant.Filled">
                                <MudIcon Icon="@_invoice.StageIcon" Class="mr-1" />
                                @_invoice.StageName
                            </MudChip>
                            <MudChip T="string" Color="@GetPrimaryStatusColor(_invoice.PrimaryStatus)" Variant="Variant.Text">
                                @Loc[$"InvoicePrimaryStatus_{_invoice.PrimaryStatus}"]
                            </MudChip>
                            <MudChip T="string" Variant="Variant.Outlined">@FormatAmount(_invoice)</MudChip>
                            <MudChip T="string" Variant="Variant.Outlined">@FormatDate(_invoice.InvoiceDate)</MudChip>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <MudGrid Spacing="3" Class="invoice-detail-grid mt-3">
                <MudItem xs="12" md="8">
                    <MudPaper Elevation="0" Outlined="true">
                        <MudTabs Elevation="0" Rounded="false" ApplyEffectsToContainer="true" PanelClass="pa-4">

                            @* ── Tab 1: Übersicht ── *@
                            <MudTabPanel Text="@Loc["InvoiceDetail_TabOverview"]" Icon="@Icons.Material.Outlined.Info">
                                <MudStack Spacing="4">
                                    <div>
                                        <MudText Typo="Typo.subtitle2" Class="invoice-detail-section-title mb-3">@Loc["InvoiceDetailSectionInvoice"]</MudText>
                                        <MudGrid Spacing="2">
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["TableHeaderTicketNumber"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatValue(_invoice.TicketNumber)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["TableHeaderCompany"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatCompany(_invoice)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["TableHeaderAmount"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatAmount(_invoice)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["TableHeaderInvoiceDate"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatDate(_invoice.InvoiceDate)</MudText>
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["InvoicePrimaryStatusLabel"]</MudText>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudText Typo="Typo.body1" Color="@GetPrimaryStatusColor(_invoice.PrimaryStatus)">@Loc[$"InvoicePrimaryStatus_{_invoice.PrimaryStatus}"]</MudText>
                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">(@_invoice.StageName)</MudText>
                                                </MudStack>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["InvoiceDetailCreatedLabel"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatDateTime(_invoice.CreatedAt)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["InvoiceDetailUpdatedLabel"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatDateTime(_invoice.UpdatedAt)</MudText>
                                            </MudItem>
                                        </MudGrid>
                                    </div>

                                    <MudDivider />

                                    <div>
                                        <MudText Typo="Typo.subtitle2" Class="invoice-detail-section-title mb-3">@Loc["InvoiceDetailSectionCustomer"]</MudText>
                                        <MudGrid Spacing="2">
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["AdminTableHeaderUser"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatValue(_invoice.UserName)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["InvoiceDetailEmailLabel"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatValue(_invoice.UserEmail)</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["AdminTableHeaderCustomerNumber"]</MudText>
                                                <MudText Typo="Typo.body1">@FormatValue(_invoice.CustomerNumber)</MudText>
                                            </MudItem>
                                        </MudGrid>
                                    </div>
                                </MudStack>
                            </MudTabPanel>

                            @* ── Tab 2: Dokumente ── *@
                            <MudTabPanel Text="@Loc["InvoiceDetail_TabDocuments"]" Icon="@Icons.Material.Outlined.UploadFile">
                                <MudStack Spacing="4">

                                    @* ── Invoice + POA downloads ── *@
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["AdminTableHeaderFile"]</MudText>
                                        @if (!string.IsNullOrWhiteSpace(_invoice.FilePath))
                                        {
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       Size="Size.Small"
                                                       DisableElevation="true"
                                                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                                                       Href="@GetFileUrl(_invoice.FilePath)"
                                                       Target="_blank">
                                                @Loc["InvoiceDetailDownloadPdf"]
                                            </MudButton>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body1">-</MudText>
                                        }
                                    </MudStack>
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["AdminTableHeaderPowerOfAttorney"]</MudText>
                                        @if (!string.IsNullOrWhiteSpace(_invoice.PowerOfAttorneyPath))
                                        {
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       Size="Size.Small"
                                                       DisableElevation="true"
                                                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                                                       Href="@GetFileUrl(_invoice.PowerOfAttorneyPath)"
                                                       Target="_blank">
                                                @Loc["InvoiceDetailDownloadPdf"]
                                            </MudButton>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body1">-</MudText>
                                        }
                                    </MudStack>

                                    <MudDivider />

                                    @* ── Client-uploaded documents ── *@
                                    <MudStack Spacing="2">
                                        <MudText Typo="Typo.subtitle2">@Loc["AdminInvoiceDetail_ClientDocsSectionTitle"]</MudText>
                                        @if (_invoice.ClientDocuments.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2" Class="mud-text-secondary">@Loc["AdminInvoiceDetail_ClientDocsEmpty"]</MudText>
                                        }
                                        else
                                        {
                                            @foreach (var doc in _invoice.ClientDocuments)
                                            {
                                                <MudPaper Elevation="0" Class="pa-2" Style="border: 1px solid var(--mud-palette-lines-default);">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                            <MudIcon Icon="@Icons.Material.Outlined.InsertDriveFile" Size="Size.Small" Class="mud-text-secondary" />
                                                            <MudStack Spacing="0">
                                                                <MudText Typo="Typo.body2">@doc.FileName</MudText>
                                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@FormatDateTime(doc.UploadedAt)</MudText>
                                                            </MudStack>
                                                        </MudStack>
                                                        <MudIconButton Icon="@Icons.Material.Filled.Download"
                                                                       Size="Size.Small"
                                                                       Color="Color.Primary"
                                                                       Href="@GetFileUrl(doc.FilePath)"
                                                                       Target="_blank"
                                                                       Title="@Loc["InvoiceDetail_ClientDocsDownload"]" />
                                                    </MudStack>
                                                </MudPaper>
                                            }
                                        }
                                    </MudStack>

                                </MudStack>
                            </MudTabPanel>

                            @* ── Tab 3: Kommunikation (with note count badge) ── *@
                            <MudTabPanel Icon="@Icons.Material.Outlined.Chat">
                                <TabContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <span>@Loc["InvoiceDetail_TabCommunication"]</span>
                                        @if (_noteCount > 0)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled" Class="ml-1" Style="height:18px;min-width:18px;padding:0 5px;font-size:11px;">@_noteCount</MudChip>
                                        }
                                    </MudStack>
                                </TabContent>
                                <ChildContent>
                                    @if (_notes.Count == 0)
                                    {
                                        <MudStack AlignItems="AlignItems.Center" Class="py-8">
                                            <MudIcon Icon="@Icons.Material.Outlined.ChatBubbleOutline" Size="Size.Large" Class="mud-text-secondary" />
                                            <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">@Loc["InvoiceDetail_TabCommunicationEmpty"]</MudText>
                                        </MudStack>
                                    }
                                    else
                                    {
                                        <MudStack Spacing="2">
                                            @foreach (var note in _notes)
                                            {
                                                <MudPaper Elevation="0" Class="pa-3" Style="border-left: 3px solid var(--mud-palette-primary); background: var(--mud-palette-background-grey);">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-1">
                                                        <MudText Typo="Typo.subtitle2">@Loc["InvoiceDetail_NoteFrom"]</MudText>
                                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@FormatDateTime(note.ChangedAt)</MudText>
                                                    </MudStack>
                                                    <MudText Typo="Typo.body2">@note.Note</MudText>
                                                </MudPaper>
                                            }
                                        </MudStack>
                                    }
                                </ChildContent>
                            </MudTabPanel>

                        </MudTabs>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudPaper Class="invoice-detail-card invoice-detail-timeline pa-4" Elevation="0" Outlined="true">
                        <MudText Typo="Typo.subtitle1" Class="invoice-detail-section-title">@Loc["InvoiceDetailHistoryTitle"]</MudText>
                        @if (_history.Count == 0)
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mt-2">@Loc["InvoiceDetailHistoryEmpty"]</MudText>
                        }
                        else
                        {
                    <div class="oikos-timeline mt-4">
                        @foreach (var entry in _history)
                        {
                            <div class="oikos-timeline-item">
                                <div class="oikos-timeline-marker marker-solid-blue"></div>
                                <div class="oikos-timeline-content">
                                    <div class="oikos-timeline-header">
                                        <span class="oikos-timeline-title">@entry.StageName</span>
                                        @if (string.IsNullOrWhiteSpace(entry.ChangedBy) || entry.ChangedBy == Loc["InvoiceDetailSystemUser"].Value)
                                        {
                                            <span class="oikos-timeline-intern-badge">@Loc["InvoiceDetail_InternBadge"]</span>
                                        }
                                    </div>
                                    <div class="oikos-timeline-time">@FormatDateTime(entry.ChangedAt)</div>
                                    @if (!string.IsNullOrWhiteSpace(entry.Note))
                                    {
                                        <div class="oikos-timeline-description">@entry.Note</div>
                                    }
                                    else if (!string.IsNullOrWhiteSpace(entry.ChangedBy) && entry.ChangedBy != Loc["InvoiceDetailSystemUser"].Value)
                                    {
                                        <div class="oikos-timeline-description">
                                            @string.Format(Loc["InvoiceDetailHistoryChangedBy"].Value, entry.ChangedBy)
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
    </ChildContent>
</PageLayout>
