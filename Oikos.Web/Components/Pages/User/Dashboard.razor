@page "/dashboard"
@rendermode InteractiveServer
@using Oikos.Common.Resources
@using Oikos.Domain.Enums

<div class="oikos-dashboard pb-10">
    <div class="oikos-dashboard-header mb-6">
        <div class="oikos-header-content">
            <MudText Typo="Typo.h4" Class="fw-bold">Dashboard</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary">@_greetingText</MudText>
        </div>
        <div class="oikos-header-actions">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@NavigateToNewClaim"
                       Class="rounded-lg px-6 py-2">
                @Loc["HomePage_NewClaimTitle"]
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Variant="Variant.Outlined"
                           Class="rounded-lg ml-2"
                           OnClick="@(() => OnInitializedAsync())" />
        </div>
    </div>

    @if (_news is not null)
    {
        <MudPaper Elevation="0" Outlined="true" Class="oikos-news-banner rounded-xl pa-4 mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                <div class="oikos-news-icon">
                    <MudIcon Icon="@Icons.Material.Filled.NotificationsNone" Color="Color.Primary" />
                </div>
                <MudStack Spacing="0">
                    <MudLink Typo="Typo.h6" Href="@_news.Link" Underline="Underline.None" Class="oikos-news-title" Target="_blank">@_news.Title</MudLink>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@_news.Summary</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    }

    <MudPaper Elevation="0" Outlined="true" Class="oikos-plan-banner rounded-xl pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                <div class="oikos-plan-usage">
                    <div class="oikos-usage-circle">
                        @if (_totalClaims > 0)
                        {
                            <span class="usage-text">@_remainingClaims/@_totalClaims</span>
                        }
                        else
                        {
                            <span class="usage-text">∞</span>
                        }
                    </div>
                    <span class="plan-label">@_planName</span>
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h6">@_planName</MudText>
                    @if (_totalClaims > 0)
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">@string.Format("{0} von {1} Fällen verfügbar", _remainingClaims, _totalClaims)</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Unbegrenzte Fälle verfügbar</MudText>
                    }
                </MudStack>
            </MudStack>
            <MudButton Variant="Variant.Text"
                       EndIcon="@Icons.Material.Filled.TrendingUp"
                       Color="Color.Inherit"
                       Href="@PricingUrl"
                       Class="oikos-upgrade-btn">
                Upgrade
            </MudButton>
        </MudStack>
    </MudPaper>

    @* Status Cards *@
    <MudGrid Spacing="4" Class="mb-8">
        @for (int i = 0; i < _statusSummaries.Count; i++)
        {
            var summary = _statusSummaries[i];
            var mdSize = i < 4 ? 3 : 4;
            <MudItem xs="12" sm="6" md="@mdSize">
                <MudPaper Elevation="0"
                          Outlined="true"
                          Class="@($"oikos-status-card rounded-xl pa-5 {summary.CssClass}")"
                          Style="@summary.Style"
                          @onclick="@(() => NavigateTo(summary.TargetUri))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">@summary.Name</MudText>
                            <MudText Typo="Typo.h4" Class="fw-bold">@summary.Count</MudText>
                        </MudStack>
                        <div class="oikos-card-icon-nested">
                            <MudIcon Icon="@summary.Icon" />
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>

    @* Bottom Two-Column: Aktuelle Fälle + Letzte Aktivitäten *@
    <MudGrid Spacing="4">
        <MudItem xs="12" md="7">
            <MudPaper Elevation="0" Outlined="true" Class="rounded-xl pa-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h6" Style="font-weight:600;">@Loc["Dashboard_RecentCases_Title"]</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["Dashboard_RecentCases_Subtitle"]</MudText>
                    </MudStack>
                    <MudLink Href="/invoices" Underline="Underline.None" Class="d-flex align-center" Style="font-size:0.85rem; gap:4px;">
                        @Loc["Dashboard_RecentCases_ShowAll"] <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                    </MudLink>
                </MudStack>

                @if (_recentInvoices.Count == 0)
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary pa-2">@Loc["Dashboard_RecentCases_Empty"]</MudText>
                }
                else
                {
                    @foreach (var inv in _recentInvoices)
                    {
                        <div class="oikos-case-row">
                            <MudStack Spacing="0">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Style="font-weight:600;">@(inv.TicketNumber ?? $"#{inv.Id}")</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(inv.PrimaryStatus)" Variant="Variant.Filled" Style="margin:0; height:20px;">
                                        @GetStatusLabel(inv.PrimaryStatus)
                                    </MudChip>
                                </MudStack>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@(inv.Company ?? "-")</MudText>
                            </MudStack>
                            <MudStack Spacing="0" Style="text-align:right;">
                                @if (!string.IsNullOrWhiteSpace(inv.Amount))
                                {
                                    <MudText Typo="Typo.body2" Style="font-weight:600;">@inv.Amount @inv.Currency</MudText>
                                }
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@inv.UpdatedAt.ToString("dd.MM.yy")</MudText>
                            </MudStack>
                        </div>
                    }
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="5">
            <MudPaper Elevation="0" Outlined="true" Class="rounded-xl pa-4">
                <MudStack Spacing="0" Class="mb-3">
                    <MudText Typo="Typo.h6" Style="font-weight:600;">@Loc["Dashboard_RecentActivities_Title"]</MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@Loc["Dashboard_RecentActivities_Subtitle"]</MudText>
                </MudStack>

                @if (_recentActivities.Count == 0)
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary pa-2">@Loc["Dashboard_RecentActivities_Empty"]</MudText>
                }
                else
                {
                    <div class="oikos-activity-list">
                        @foreach (var activity in _recentActivities)
                        {
                            <div class="oikos-activity-item">
                                <div class="oikos-activity-dot"></div>
                                <MudStack Spacing="0" Style="overflow:hidden;">
                                    <MudText Typo="Typo.body2" Style="font-weight:600;">@activity.StageName</MudText>
                                    @if (!string.IsNullOrWhiteSpace(activity.Note))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary" Style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">@activity.Note</MudText>
                                    }
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@activity.ChangedAt.ToString("dd. MMM yyyy, HH:mm")</MudText>
                                </MudStack>
                            </div>
                        }
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</div>
